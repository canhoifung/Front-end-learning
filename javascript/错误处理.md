# 错误处理

两种错误：

1. 程序逻辑错误，代码执行异常
2. 程序遭遇无法预测的异常情况，如网络连接中断、读取不存在的文件，没有操作权限等

## `try...catch...finally`

```javascript
var r1, r2, s = null;
try {
    r1 = s.length; // 此处应产生错误
    r2 = 100; // 该语句不会执行
} catch (e) {
    console.log('出错了：' + e);
} finally {
    console.log('finally');
}
console.log('r1 = ' + r1); // r1应为undefined
console.log('r2 = ' + r2); // r2应为undefined

```

`try{...}`包含的代码表示执行过程中可能会发生错误，若发生了错误就不再继续执行，跳转到`catch(e){...}`块，若没有发生错误，则不会执行`catch(e){...}`的代码；

`catch(e){...}`包裹的代码是错误处理代码，变量`e`表示捕获到的错误；

`finally`包裹的代码无论是否发生错误都会执行。

> `catch`与`finally`可以忽略，不必都出现，视情况需要

## 错误类型

表示错误的有：标准的`Error`对象、从其派生出来的`TypeError`、`ReferenceError`等错误类型

```javascript
try {
    ...
} catch (e) {
    if (e instanceof TypeError) {
        alert('Type error!');
    } else if (e instanceof Error) {
        alert(e.message);
    } else {
        alert('Error: ' + e);
    }
}
```

## 抛出错误

使用`throw`语句使执行流程直接跳转到`catch`块

```javascript
var r, n, s;
try {
    s = prompt('请输入一个数字');
    n = parseInt(s);
    if (isNaN(n)) {
        throw new Error('输入错误');
    }
    // 计算平方:
    r = n * n;
    console.log(n + ' * ' + n + ' = ' + r);
} catch (e) {
    console.log('出错了：' + e);
}
```

![1568773657744](错误处理.assets/1568773657744.png)

>JavaScript允许抛出任意对象，包括数字、字符串。但是，最好还是抛出一个Error对象。
>
>```javascript
>throw ('输入错误')
>```
>
>![1568773706148](错误处理.assets/1568773706148.png)

==使用`catch`捕获错误时一定要编写错误处理语句==

# 错误传播

如果在一个函数内部发生了错误，它自身没有捕获，错误就会被抛到外层调用函数，如果外层函数也没有捕获，该错误会一直沿着函数调用链向上抛出，直到被JavaScript引擎捕获，代码终止执行。

```javascript
function main(s) {
    console.log('BEGIN main()');
    try {
        foo(s);
    } catch (e) {
        console.log('出错了：' + e);
    }
    console.log('END main()');
}

function foo(s) {
    console.log('BEGIN foo()');
    bar(s);
    console.log('END foo()');
}

function bar(s) {
    console.log('BEGIN bar()');
    console.log('length = ' + s.length);
    console.log('END bar()');
}

main(null);

```

```javascript
//调试结果：
BEGIN main()
BEGIN foo()
BEGIN bar()
出错了：TypeError: Cannot read property 'length' of null
END main()
```

# 异步错误处理

```javascript
function printTime() {
    throw new Error();
}

try {
    setTimeout(printTime, 1000);
    console.log('done');
} catch (e) {
    console.log('error');
}
// done
```

在调用`setTimeout()`函数时，传入的`printTime`函数并没有立刻执行，1秒后才开始执行并发生错误，但该错误只在`printTime`函数内部捕获到错误。

解决方法：

```javascript
setTimeout(function(){
    try{
        printTime();
    }catch(e){
        console.log(e);
    }
}, 1000)
```

哪里出现错误就在哪里使用`try`、`catch`捕获