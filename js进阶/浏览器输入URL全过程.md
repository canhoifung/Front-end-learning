# 网络篇

1. 浏览器构建请求行

2. 发送请求前，检查请求头设置的强缓存失效时间，命中就直接使用，否则开始DNS解析

3. DNS解析（将IP地址和域名进行一一对应），流程为：

   1. 查找浏览器缓存

      若域名被解析过，浏览器会将结果缓存，在缓存失效前都可以直接走缓存不需要进行DNS解析

   2. 查找系统Host文件配置

      去本地硬盘Host文件进行查找，查找有无对应域名和IP地址的规则，有规则直接使用

   3. 浏览器发送DNS请求到本地DNS服务器

      本地DNS服务器接受到请求后，递归查找自己的缓存记录，有缓存直接返回

   4. 根DNS服务器

      这一个步骤不会直接返回域名和IP对应关系，而是给出域服务器的地址，让本地DNS服务器到域服务器上查找

   5. 本地DNS服务器向域服务器发送请求

      域服务器接受请求后，会告诉本地DNS服务器请求的域名的解析服务器的地址

   6. 本地DNS服务器向解析服务器发送请求

      获取到域名和IP地址的对应关系，将关系返回给浏览器，并缓存到本地

4. 建立TCP连接

   不指定端口下，浏览器会以随机端口向Web服务器程序的80端口发起TCP请求，连接请求进入内核的TCP/IP协议栈，还可能经过防火墙过滤，最终抵达Web服务器程序，建立TCP连接

   建立TCP连接的是三个阶段：

   1. 通过三次握手建立客户端和服务端的连接；
      1. 客户端发起请求，并将自己的状态设置为待连接状态；
      2. 服务端接收到请求，并返回响应，同时也将自己的状态设置为待连接状态；
      3. 客户端接收到响应之后，发出信息告诉服务端自己已经接收到请求，同时将自己的状态设置为已连接；
      4. 服务端接收到信息后，将自己的状态设置为已连接；
      5. 客户端和服务端可以正式开始通信。
   2. 进行数据传输
      1. 此处接收方收到数据包需要向发送方确认，若无确认会重新发送该数据包
      2. 发送方可以将数据包分成多个小数据包，一次传输到接收方，由接收方组装恢复
   3. 通过四次挥手断开连接
      1. 客户端发送请求，通知服务端将要断开连接，同时将自己的状态设置为待断开状态；
      2. 服务器接收到请求之后，通知客户端，当前可能还有响应没有发送完；
      3. 服务端发送完所有响应之后，通知客户端所有响应均已发送，可以断开连接，同时将自己状态设置为待断开状态；
      4. 客户端接收到通知后，将自己的状态设置为断开状态，同时通知服务端自己已经断开；
      5. 服务端接收到通知后，也将自己的状态设置为断开状态；
      6. 服务端和客户端通信正式断开。
   
5. 发送HTTP请求

   必须携带三样东西：

   1. 请求行。包括请求方法字段、URL字段、HTTP协议版本，如`GET/index.html HTTP/1.1`
   2. 请求头。由键值对组成，通知服务器有关客户端请求的信息，常见的有：`User-Agent`、`Accept`、`Host`、`Content-Type`
   3. 请求体。在post方法中使用，适用于填写表单的场合
   4. 空行。告诉服务器请求头到此为止

6. 服务器处理请求

7. 相应HTTP请求

   三个东西：

   1. 响应行。由协议版本、状态码及其描述组成，如`HTTP/1.1 200 OK`
   2. 响应头。描述服务器的基本信息和数据
   3. 响应体。返回的信息内容
   
   HTTP应答码整理：
   
   - `1XX`－信息类(Information),表示收到Web浏览器请求，正在进一步的处理中 
   - `2XX`－成功类（Successful）,表示用户请求被正确接收，理解和处理例如：200 OK 
   - `3XX` - 重定向类(Redirection),表示请求没有成功，客户必须采取进一步的动作。 
   - `4XX `- 客户端错误(Client Error)，表示客户端提交的请求有错误 例如：404 NOT Found，意味着请求中所引用的文档不存在。 
   - `5XX` - 服务器错误(Server Error)表示服务器不能完成对请求的处理：如 500 



# 解析算法篇

若响应头中`Content-type:text/html`，那么就开始解析渲染

一、构建DOM树和CSSOM树

1. 构建DOM树
   1. 读取HTML文档
   2. 将字节转换成字符
   3. 确定标签
   4. 将标签转换成节点
   5. 以节点构建DOM树
2. 构建CSSOM树
   1. 读取CSS文档
   2. 将字节转换成字符
   3. 确定标签
   4. 将标签转换成节点
   5. 以节点构建CSSOM树
3. 加载JS
   + 将堵塞DOM树加载
     + 解决方法1：`defer`属性，先下载JS文件等HTML解析后才开始执行已经下载的脚本
       + 脚本在`DOMContentLoaded`事件触发前执行（即刚读取完`</html>`标签）
       + 脚本内部不能使用`document.write()`
       + 脚本同时有`defer`、`async`，则`defer`不起效
     + 解决方法2：`async`属性，解析HTML网页同时并行下载脚本，下载完成后暂停解析HTML开始执行脚本，执行完成后就像解析HTML网页
       + 无法保证脚本执行顺序
       + 脚本内部不能使用`document.write()`

二、页面重绘`repaint`和重流`reflow`

1. 渲染树转换为网页布局称为布局流（`flow`）
   
1. 渲染树节点发生变化，但不影响节点的空间位置和大小，就会触发重绘（`repaint`）
   
2. 布局显示到页面称为绘制（`paint`）

   1. 渲染树节点发生改变，且节点几何属性改变，则会触发重流（`reflow`）
3. ==重流必定重绘，重绘不一定重流==
   

   

